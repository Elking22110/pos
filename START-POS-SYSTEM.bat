@echo off
chcp 65001 > nul
title ูุธุงู ููุงุท ุงูุจูุน - ุงูุณูุฑูุจุช ุงูุฑุฆูุณู
color 0A

echo.
echo ========================================
echo    ูุธุงู ููุงุท ุงูุจูุน - ุงูุณูุฑูุจุช ุงูุฑุฆูุณู
echo ========================================
echo.

echo ุงูุชุญูู ูู ุงููุฌูุฏ ุงูุญุงูู...
cd /d "%~dp0"
echo ุงููุฌูุฏ ุงูุญุงูู: %CD%

echo.
echo ุงูุชุญูู ูู ูุฌูุฏ package.json...
if not exist "package.json" (
    echo ุฎุทุฃ: ููู package.json ุบูุฑ ููุฌูุฏ!
    echo ุชุฃูุฏ ูู ุฃูู ูู ุงููุฌูุฏ ุงูุตุญูุญ
    pause
    exit /b 1
)

echo.
echo ุงูุชุญูู ูู Node.js...
node --version
if %errorlevel% neq 0 (
    echo ุฎุทุฃ: Node.js ุบูุฑ ูุซุจุช ุฃู ุบูุฑ ููุฌูุฏ ูู PATH
    echo ูุฑุฌู ุชุซุจูุช Node.js ูู: https://nodejs.org
    pause
    exit /b 1
)

echo.
echo ุงูุชุญูู ูู npm...
npm --version
if %errorlevel% neq 0 (
    echo ุฎุทุฃ: npm ุบูุฑ ูุซุจุช ุฃู ุบูุฑ ููุฌูุฏ ูู PATH
    pause
    exit /b 1
)

echo.
echo ========================================
echo    ูุญุต ุงููููุฐ ุงูุฑุฆูุณู 5173
echo ========================================
echo.

REM ูุญุต ุงููููุฐ 5173
netstat -an | findstr :5173 > nul
if %errorlevel% equ 0 (
    echo โ๏ธ  ุงููููุฐ 5173 ูุณุชุฎุฏู ุจุงููุนู
    echo.
    echo ูู ุชุฑูุฏ:
    echo 1. ุฅููุงู ุงูุนูููุฉ ุงูุชู ุชุณุชุฎุฏู ุงููููุฐ 5173
    echo 2. ุงุณุชุฎุฏุงู ูููุฐ ุขุฎุฑ (5174)
    echo 3. ุฅูุบุงุก ุงูุชุดุบูู
    echo.
    set /p choice="ุงุฎุชุฑ ุฑูู (1/2/3): "
    
    if "%choice%"=="1" (
        echo.
        echo ุฌุงุฑู ุฅููุงู ุงูุนูููุงุช ุงูุชู ุชุณุชุฎุฏู ุงููููุฐ 5173...
        for /f "tokens=5" %%a in ('netstat -ano ^| findstr :5173') do (
            taskkill /PID %%a /F >nul 2>&1
        )
        echo ุชู ุฅููุงู ุงูุนูููุงุช
        set PORT=5173
        set PORT_MESSAGE=ุณูุชู ุชุดุบูู ุงูุฎุงุฏู ุนูู ุงููููุฐ ุงูุฑุฆูุณู 5173
    ) else if "%choice%"=="2" (
        echo.
        echo ุฌุงุฑู ุงูุจุญุซ ุนู ูููุฐ ูุชุงุญ...
        netstat -an | findstr :5174 > nul
        if %errorlevel% neq 0 (
            echo โ ุงููููุฐ 5174 ูุชุงุญ
            set PORT=5174
            set PORT_MESSAGE=ุณูุชู ุชุดุบูู ุงูุฎุงุฏู ุนูู ุงููููุฐ 5174
        ) else (
            echo โ ุงููููุฐ 5174 ุฃูุถุงู ูุณุชุฎุฏู
            echo ูุฑุฌู ุฅุนุงุฏุฉ ุชุดุบูู ุงูููุจููุชุฑ ุฃู ุฅุบูุงู ุงูุชุทุจููุงุช ุงูุฃุฎุฑู
            pause
            exit /b 1
        )
    ) else (
        echo ุชู ุฅูุบุงุก ุงูุชุดุบูู
        pause
        exit /b 0
    )
) else (
    echo โ ุงููููุฐ ุงูุฑุฆูุณู 5173 ูุชุงุญ
    set PORT=5173
    set PORT_MESSAGE=ุณูุชู ุชุดุบูู ุงูุฎุงุฏู ุนูู ุงููููุฐ ุงูุฑุฆูุณู 5173
)

echo.
echo %PORT_MESSAGE%
echo.

echo ุชุซุจูุช ุงูุชุจุนูุงุช...
npm install

echo.
echo ========================================
echo    ุชุดุบูู ุฎุงุฏู ุงูุชุทููุฑ
echo ========================================
echo.

REM ุงูุญุตูู ุนูู ุนููุงู IP ุงููุญูู
for /f "tokens=2 delims=:" %%a in ('ipconfig ^| findstr "IPv4"') do (
    for /f "tokens=1" %%b in ("%%a") do (
        set LOCAL_IP=%%b
        goto :found_ip
    )
)
:found_ip

echo ุงูุฎุงุฏู ุณูุนูู ุนูู:
echo.
echo ๐ฅ๏ธ  ุงููุญูู: http://localhost:%PORT%
if defined LOCAL_IP (
    echo ๐ ุงูุดุจูุฉ ุงููุญููุฉ: http://%LOCAL_IP%:%PORT%
)
echo.
echo ๐ฑ ูููุตูู ูู ุงูุฃุฌูุฒุฉ ุงูุฃุฎุฑู:
echo    ุงุณุชุฎุฏู ุนููุงู ุงูุดุจูุฉ ุงููุญููุฉ ุฃุนูุงู
echo.
echo โ๏ธ  ุงุถุบุท Ctrl+C ูุฅููุงู ุงูุฎุงุฏู
echo.

REM ุชุดุบูู ุงูุฎุงุฏู ูุน ุงููููุฐ ุงููุญุฏุฏ
set VITE_PORT=%PORT%
npm run dev

echo.
echo ุชู ุฅููุงู ุงูุฎุงุฏู
pause
